{% extends "base.html" %}

{% block title %}Reporte de Error{% endblock %}

{% block content %}

<div class="container mt-4" style="max-width: 900px;">

    <!-- FORMULARIO -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Registrar Reporte de Error</h4>
        </div>

        <div class="card-body">

            <form id="errorForm" method="POST">
                {% csrf_token %}

                <div class="mb-3">
                    <label class="form-label">Título</label>
                    {{ form.titulo }}
                </div>

                <div class="mb-3">
                    <label class="form-label">Descripción</label>
                    {{ form.descripcion }}
                </div>

                <div class="mb-3">
                    <label class="form-label">Tipo de Error</label>
                    {{ form.tipo_error }}
                </div>

                <div class="mb-3">
                    <label class="form-label">URL</label>
                    {{ form.url }}
                </div>

                <div class="mb-3">
                    <label class="form-label">Método HTTP</label>
                    {{ form.metodo_http }}
                </div>

                <div class="mb-3">
                    <label class="form-label">IP Cliente</label>
                    {{ form.ip_cliente }}
                </div>

                <button type="submit" class="btn btn-success w-100">
                    Enviar Reporte
                </button>
            </form>

            <div id="respuesta" class="mt-3"></div>

        </div>
    </div>

    <!-- TABLA -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0">Reportes Registrados</h4>
        </div>

        <div class="card-body">

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-secondary">
                        <tr>
                            <th>Título</th>
                            <th>Tipo</th>
                            <th>URL</th>
                            <th>Método</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="tablaReportes"></tbody>
                </table>
            </div>

        </div>
    </div>

</div>

<script>

// ================= CARGAR REPORTES =================
function cargarReportes() {

    fetch("{% url 'obtener_reportes' %}")
    .then(response => response.json())
    .then(data => {

        let tabla = document.getElementById("tablaReportes");
        tabla.innerHTML = "";

        data.forEach(reporte => {

            let filaColor = "";

            if(reporte.tipo_error === "Familia 400"){
                filaColor = "table-warning";
            }
            else if(reporte.tipo_error === "Familia 500"){
                filaColor = "table-danger";
            }

            tabla.innerHTML += `
                <tr class="${filaColor}">
                    <td>${reporte.titulo}</td>
                    <td><span class="badge bg-secondary">${reporte.tipo_error}</span></td>
                    <td>${reporte.url}</td>
                    <td>${reporte.metodo_http}</td>
                    <td>${new Date(reporte.fecha_reporte).toLocaleString()}</td>
                </tr>
            `;
        });
    });
}


// ================= ENVÍO FORMULARIO =================
document.getElementById("errorForm").addEventListener("submit", function(e){
    e.preventDefault();

    let formData = new FormData(this);

    fetch("", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {

        let respuestaDiv = document.getElementById("respuesta");

        if(data.status === "ok"){

            respuestaDiv.innerHTML = `
                <div class="alert alert-success">
                    ${data.mensaje}
                </div>
            `;

            this.reset();
            cargarReportes();
        }
        else {

            let erroresHtml = "";

            for (let campo in data.errors) {
                erroresHtml += `<li>${campo}: ${data.errors[campo]}</li>`;
            }

            respuestaDiv.innerHTML = `
                <div class="alert alert-danger">
                    ${data.mensaje}
                    <ul>${erroresHtml}</ul>
                </div>
            `;
        }
    });
});

document.addEventListener("DOMContentLoaded", cargarReportes);

</script>

{% endblock %}
