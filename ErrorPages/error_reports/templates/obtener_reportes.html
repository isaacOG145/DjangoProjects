{% extends "base.html" %}

{% block title %}Reporte de Error{% endblock %}

{% block content %}

<div class="col-10 mx-auto">

    <h2 class="mb-4">Registrar Error</h2>

    <form id="errorForm">
        {% csrf_token %}
        {{ form.as_p }}

        <button type="submit" class="btn btn-primary">
            Enviar Reporte
        </button>
    </form>

    <div id="respuesta" class="mt-3"></div>

    <hr class="my-5">

    <h3>Reportes Registrados</h3>

    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Tipo</th>
                    <th>URL</th>
                    <th>Fecha</th>
                    <th>Ver JSON</th>
                </tr>
            </thead>
            <tbody id="tablaReportes"></tbody>
        </table>
    </div>

    <h4 class="mt-4">Detalle en formato JSON</h4>

    <pre id="jsonViewer" class="p-3 bg-light border rounded" style="min-height:150px;">
Seleccione un reporte...
    </pre>

</div>

<script>

// =============================
// CARGAR REPORTES EN TABLA
// =============================
function cargarReportes() {

    fetch("/obtener-reportes/")
    .then(response => response.json())
    .then(data => {

        let tbody = document.getElementById("tablaReportes");
        tbody.innerHTML = "";

        data.forEach(reporte => {

            let claseFila = "";

            if (reporte.tipo_error.startsWith("4")) {
                claseFila = "table-warning";
            }

            if (reporte.tipo_error.startsWith("5")) {
                claseFila = "table-danger";
            }

            tbody.innerHTML += `
                <tr class="${claseFila}">
                    <td>${reporte.id}</td>
                    <td>${reporte.titulo ?? "Sin título"}</td>
                    <td>${reporte.tipo_error}</td>
                    <td>${reporte.url}</td>
                    <td>${reporte.fecha_reporte}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary"
                            onclick='mostrarJSON(${JSON.stringify(reporte)})'>
                            Ver
                        </button>
                    </td>
                </tr>
            `;
        });

    });
}

cargarReportes();


// =============================
// MOSTRAR JSON EN RECUADRO
// =============================
function mostrarJSON(reporte) {

    let viewer = document.getElementById("jsonViewer");

    viewer.textContent = JSON.stringify(reporte, null, 4);
}


// =============================
// ENVÍO FORMULARIO (AJAX)
// =============================
document.getElementById("errorForm").addEventListener("submit", function(e){

    e.preventDefault();

    let formData = new FormData(this);

    fetch("", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {

        let respuesta = document.getElementById("respuesta");

        if(data.status === "ok"){

            respuesta.innerHTML = `
                <div class="alert alert-success">
                    ${data.mensaje}
                </div>
            `;

            this.reset();
            cargarReportes();

        } else {

            let erroresHTML = "";

            for (let campo in data.errors) {
                erroresHTML += `<li>${campo}: ${data.errors[campo]}</li>`;
            }

            respuesta.innerHTML = `
                <div class="alert alert-danger">
                    ${data.mensaje}
                    <ul>${erroresHTML}</ul>
                </div>
            `;
        }
    });

});
</script>

{% endblock %}
